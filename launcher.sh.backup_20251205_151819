#!/bin/bash

# TrafficSenseAI Enhanced Launcher with PID Analysis
# Launches autonomous system, waits for Gazebo to close, then generates performance graphs

set -e  # Exit on error

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Project configuration
PROJECT_DIR="$HOME/Desktop/TrafficSenseAI"
LOG_DIR="$PROJECT_DIR/test_logs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="$LOG_DIR/launch_${TIMESTAMP}.log"
PID_FILE="/tmp/traffic_sense_pids.pid"

# Performance data file
PERFORMANCE_FILE="$PROJECT_DIR/pid_performance.json"

# Plotting script
PLOT_SCRIPT="$PROJECT_DIR/src/traffic_light_robot/scripts/plot_pid_performance.py"

# Print functions
print_header() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}========================================${NC}"
}

print_status() {
    echo -e "${BLUE}[$(date +"%H:%M:%S")]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[$(date +"%H:%M:%S")] âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}[$(date +"%H:%M:%S")] âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[$(date +"%H:%M:%S")] âš ${NC} $1"
}

print_info() {
    echo -e "${MAGENTA}[$(date +"%H:%M:%S")] â„¹${NC} $1"
}

# Cleanup function
cleanup() {
    print_warning "Initiating cleanup..."
    
    # Kill all tracked processes
    if [ -f "$PID_FILE" ]; then
        while IFS= read -r pid; do
            if ps -p "$pid" > /dev/null 2>&1; then
                print_status "Terminating process $pid"
                kill -TERM "$pid" 2>/dev/null || true
                sleep 0.5
                
                # Force kill if still alive
                if ps -p "$pid" > /dev/null 2>&1; then
                    kill -9 "$pid" 2>/dev/null || true
                fi
            fi
        done < "$PID_FILE"
        rm -f "$PID_FILE"
    fi
    
    # Kill any remaining ROS2/Gazebo processes
    print_status "Cleaning up ROS2 and Gazebo processes..."
    pkill -f "ros2 launch" 2>/dev/null || true
    pkill -f "ros2 run" 2>/dev/null || true
    pkill -f "gzserver" 2>/dev/null || true
    pkill -f "gzclient" 2>/dev/null || true
    
    sleep 1
    print_success "Cleanup complete"
}

# Set trap for cleanup
trap cleanup SIGINT SIGTERM

# Create log directory
mkdir -p "$LOG_DIR"

# Clear screen and show header
clear
print_header "TrafficSenseAI - Autonomous System Launcher"
echo ""
echo -e "${CYAN}Timestamp:${NC} $(date '+%Y-%m-%d %H:%M:%S')"
echo -e "${CYAN}Log file:${NC} $LOG_FILE"
echo ""

# Step 1: Verify project directory
print_status "Verifying project directory..."
if [ ! -d "$PROJECT_DIR" ]; then
    print_error "Project directory not found: $PROJECT_DIR"
    exit 1
fi
cd "$PROJECT_DIR"
print_success "Project directory verified"

# Step 2: Check YOLO models
print_status "Checking YOLO model files..."
MODEL_DIR="$PROJECT_DIR/src/traffic_light_robot/models"
if [ ! -f "$MODEL_DIR/yolov4-tiny.weights" ]; then
    print_warning "YOLO models not found. Downloading..."
    mkdir -p "$MODEL_DIR"
    cd "$MODEL_DIR"
    
    wget -q --show-progress https://github.com/AlexeyAB/darknet/releases/download/darknet_yolo_v4_pre/yolov4-tiny.weights || {
        print_error "Failed to download YOLO weights"
        exit 1
    }
    
    wget -q --show-progress https://raw.githubusercontent.com/AlexeyAB/darknet/master/cfg/yolov4-tiny.cfg || {
        print_error "Failed to download YOLO config"
        exit 1
    }
    
    wget -q --show-progress https://raw.githubusercontent.com/AlexeyAB/darknet/master/data/coco.names || {
        print_error "Failed to download YOLO names"
        exit 1
    }
    
    cd "$PROJECT_DIR"
    print_success "YOLO models downloaded"
else
    print_success "YOLO models found"
fi

# Step 3: Build the workspace
print_status "Building workspace..."
if colcon build --packages-select traffic_light_robot >> "$LOG_FILE" 2>&1; then
    print_success "Build completed successfully"
else
    print_error "Build failed. Check log: $LOG_FILE"
    exit 1
fi

# Step 4: Source workspace
print_status "Sourcing workspace..."
source "$PROJECT_DIR/install/setup.bash"
print_success "Workspace sourced"

# Step 5: Check if plot script exists
if [ ! -f "$PLOT_SCRIPT" ]; then
    print_warning "Plot script not found. Creating..."
    mkdir -p "$(dirname "$PLOT_SCRIPT")"
    
    # Create the plotting script directory if needed
    SCRIPT_DIR="$PROJECT_DIR/src/traffic_light_robot/scripts"
    mkdir -p "$SCRIPT_DIR"
    
    print_info "Please ensure plot_pid_performance.py is in: $SCRIPT_DIR"
fi

# Step 6: Clean old performance data
if [ -f "$PERFORMANCE_FILE" ]; then
    print_status "Archiving old performance data..."
    mv "$PERFORMANCE_FILE" "${PERFORMANCE_FILE}.backup_${TIMESTAMP}"
    print_success "Old data archived"
fi

# Step 7: Launch autonomous system
echo ""
print_header "Launching Autonomous System"
print_info "Gazebo and ROS2 nodes are starting..."
print_info "Press Ctrl+C or close Gazebo to stop and generate performance graphs"
echo ""

# Launch and capture PID
ros2 launch robot_description autonomous.launch.py > "$LOG_FILE" 2>&1 &
LAUNCH_PID=$!
echo "$LAUNCH_PID" > "$PID_FILE"

print_success "Autonomous system launched (PID: $LAUNCH_PID)"
print_status "Initializing system (15 seconds)..."
sleep 15

# Verify launch is running
if ! ps -p "$LAUNCH_PID" > /dev/null 2>&1; then
    print_error "Launch process died unexpectedly"
    print_error "Check log: $LOG_FILE"
    exit 1
fi

# Step 8: Monitor Gazebo and wait for it to close
print_success "System is running"
print_info "ðŸ¤– Robot is now operating autonomously"
print_info "ðŸš¦ Monitoring traffic lights and adjusting speed with PID control"
print_info "ðŸ“Š Performance data is being collected..."
echo ""
print_warning "Close Gazebo window or press Ctrl+C to stop and generate analysis"
echo ""

# Wait for Gazebo to be running
GAZEBO_FOUND=false
for i in {1..30}; do
    if pgrep -f "gzserver" > /dev/null || pgrep -f "gzclient" > /dev/null; then
        GAZEBO_FOUND=true
        break
    fi
    sleep 1
done

if [ "$GAZEBO_FOUND" = false ]; then
    print_warning "Gazebo not detected. Waiting for launch to complete..."
fi

# Monitor Gazebo process
while ps -p "$LAUNCH_PID" > /dev/null 2>&1; do
    # Check if Gazebo is still running
    if [ "$GAZEBO_FOUND" = true ]; then
        if ! pgrep -f "gzserver" > /dev/null && ! pgrep -f "gzclient" > /dev/null; then
            print_info "Gazebo closed. Shutting down..."
            break
        fi
    fi
    sleep 2
done

# Step 9: Cleanup ROS2 processes
print_status "Stopping ROS2 nodes..."
cleanup
sleep 2

# Step 10: Generate performance graphs
echo ""
print_header "Performance Analysis"

if [ -f "$PERFORMANCE_FILE" ]; then
    print_success "Performance data found"
    print_status "Generating PID analysis graphs..."
    
    # Make plot script executable
    chmod +x "$PLOT_SCRIPT" 2>/dev/null || true
    
    # Run plotting script
    if [ -f "$PLOT_SCRIPT" ]; then
        python3 "$PLOT_SCRIPT" "$PERFORMANCE_FILE"
        
        # Check if graphs were generated
        if [ -f "$PROJECT_DIR/pid_performance_analysis.png" ]; then
            print_success "Performance graphs generated successfully"
            echo ""
            print_info "ðŸ“Š Generated files:"
            echo "   â€¢ pid_performance_analysis.png (comprehensive analysis)"
            [ -f "$PROJECT_DIR/pid_state_analysis.png" ] && echo "   â€¢ pid_state_analysis.png (state-by-state analysis)"
            echo ""
        else
            print_warning "Graphs may not have been generated"
        fi
    else
        print_warning "Plot script not found: $PLOT_SCRIPT"
        print_info "Please create the plotting script to generate graphs"
    fi
else
    print_warning "No performance data file found"
    print_info "The controller may not have collected enough data"
    print_info "Try running the system for a longer duration"
fi

# Step 11: Display summary
echo ""
print_header "Session Summary"
echo -e "${CYAN}Session timestamp:${NC} $TIMESTAMP"
echo -e "${CYAN}Log file:${NC} $LOG_FILE"
[ -f "$PERFORMANCE_FILE" ] && echo -e "${CYAN}Performance data:${NC} $PERFORMANCE_FILE"
echo ""

# Display recent log entries
if [ -f "$LOG_FILE" ]; then
    print_info "Recent log entries:"
    tail -n 10 "$LOG_FILE" | sed 's/^/   /'
    echo ""
fi

# Check if any images were generated
IMAGE_COUNT=$(find "$PROJECT_DIR" -name "*.png" -newer "$LOG_FILE" 2>/dev/null | wc -l)
if [ "$IMAGE_COUNT" -gt 0 ]; then
    print_success "Generated $IMAGE_COUNT analysis image(s)"
fi

echo ""
print_success "Launcher completed successfully"
echo ""

# Optional: Open generated images
if command -v eog &> /dev/null; then
    read -p "Open generated graphs? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        eog "$PROJECT_DIR"/*.png 2>/dev/null &
    fi
fi

exit 0